<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¬¸ì˜ ë‹µë³€ ì‘ì„±</title>
  <link rel="stylesheet" href="form-style.css">
</head>
<body>
  <div class="top-nav">
    <div class="nav-left">
      <div class="form-icon"><strong>ğŸ“„</strong></div>
      <div class="form-title-group">
        <div class="form-title-text">ë¬¸ì˜ ë‹µë³€ ì‘ì„±</div>
      </div>
    </div>

    <div class="nav-center"></div>

    <div class="nav-right">
      <button class="publish-btn" onclick="location.href='admin_inquiry_list.html'">
        ëª©ë¡ìœ¼ë¡œ
      </button>
      <div class="profile-icon">A</div>
    </div>
  </div>

  <div class="main-content">
    <div class="tab-menu">
      <button class="tab-btn" onclick="location.href='ranking.html'">ë­í‚¹</button>
      <button class="tab-btn active" onclick="location.href='admin_inquiry_list.html'">ë¬¸ì˜</button>
    </div>

    <div class="form-container">
      <div class="form-card">
        <div class="form-header">
          <input id="title" class="form-title-input" type="text" value="" readonly />
          <div class="form-description">
            <input id="meta" class="form-description-input" type="text" value="" readonly />
          </div>
        </div>
      </div>

      <div class="form-card">
        <p><strong>ë¬¸ì˜ ë‚´ìš©</strong></p>
        <p id="content" style="margin: 12px 0 20px 0;"></p>

        <p><strong>ë‹µë³€ ì…ë ¥</strong></p>
        <textarea id="answer-input" rows="5"
                  style="width:100%; margin-top:8px; padding:8px;"></textarea>

        <button class="publish-btn" style="margin-top:16px;" id="save-btn">
          ì €ì¥í•˜ê¸°
        </button>
      </div>

      <div id="msg" style="margin-top:12px; color:#5f6368;"></div>
    </div>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");   

  const titleEl = document.getElementById("title");
  const metaEl = document.getElementById("meta");
  const contentEl = document.getElementById("content");
  const answerInput = document.getElementById("answer-input");
  const msgEl = document.getElementById("msg");

  async function loadInquiry() {
    // idê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë§‰ê¸°
    if (!id) {
      msgEl.style.color = "#d93025";
      msgEl.textContent =
        "ë¬¸ì˜ IDê°€ ì£¼ì†Œì— ì—†ìŠµë‹ˆë‹¤. ë¬¸ì˜ ëª©ë¡ í™”ë©´ì—ì„œ 'ë‹µë³€í•˜ê¸°' ë²„íŠ¼ìœ¼ë¡œ ë“¤ì–´ì™€ ì£¼ì„¸ìš”.";
      console.error("ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì— inquiry_id ì—†ìŒ");
      return;
    }

    const DETAIL_API = `http://localhost:5000/api/admin/inquiries/${id}`;
    console.log("DETAIL_API =", DETAIL_API);

    try {
      const res = await fetch(DETAIL_API);

      if (!res.ok) {
        const text = await res.text();
        console.error("ì„œë²„ ì‘ë‹µ ì—ëŸ¬:", res.status, text);
        msgEl.style.color = "#d93025";
        msgEl.textContent = `ë¬¸ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (HTTP ${res.status})`;
        return;
      }

      const data = await res.json();
      console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", data);

      if (data.error) {
        msgEl.style.color = "#d93025";
        msgEl.textContent = data.error;
        return;
      }

      titleEl.value = data.title || "(ì œëª© ì—†ìŒ)";
      metaEl.value = `ì‘ì„±ì: ${data.writer || "-"} / ì‘ì„±ì¼: ${
        data.created_at || ""
      } / ë¶„ì•¼: ${data.field || "-"}`;
      contentEl.textContent = data.content || "";

      if (data.answer) {
        answerInput.value = data.answer;
      }

      msgEl.textContent = ""; // ì—ëŸ¬ ë¬¸êµ¬ ì´ˆê¸°í™”
    } catch (err) {
      console.error("loadInquiry ì˜¤ë¥˜:", err);
      msgEl.style.color = "#d93025";
      msgEl.textContent = "ë¬¸ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  async function saveAnswer() {
    const answer = answerInput.value.trim();
    if (!answer) {
      alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }
    if (!id) {
      alert("ë¬¸ì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      return;
    }

    const ANSWER_API = `http://localhost:5000/api/admin/inquiries/${id}/answer`;

    try {
      const res = await fetch(ANSWER_API, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answer }),
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      msgEl.style.color = "#188038";
      msgEl.textContent = "ë‹µë³€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
      alert("ë‹µë³€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      // location.href = 'admin_inquiry_list.html';
    } catch (err) {
      console.error("saveAnswer ì˜¤ë¥˜:", err);
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  document.getElementById("save-btn").addEventListener("click", saveAnswer);

  // í˜ì´ì§€ ë“¤ì–´ì˜¤ë©´ ë°”ë¡œ ë¡œë”©
  loadInquiry();
</script>
</body>
</html>
