<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>매장 정보 수정</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/Home.css" />
    <link rel="stylesheet" href="/static/form-style.css" />
    <link rel="stylesheet" href="/static/store_admin_edit.css" />
  </head>
  <body>
    <header class="top-nav">
      <div class="nav-left">
        <span class="form-title-text">미식의 왕</span>
      </div>
      <div class="nav-right">
        <div class="profile-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
            />
          </svg>
        </div>
      </div>
    </header>
    <main>
      <form class="form-card" id="store-edit-form">
        <h2 style="margin-bottom: 20px">매장 정보 수정</h2>
        <div class="form-label-row">
          <label for="name">가게 이름</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="form-label-row">
          <label for="address">주소</label>
          <input type="text" id="address" name="address" required />
        </div>
        <div class="form-label-row">
          <label for="open">오픈 시간</label>
          <input type="text" id="open" name="open" />
        </div>
        <div class="form-label-row">
          <label for="close">마감 시간</label>
          <input type="text" id="close" name="close" />
        </div>
        <div class="form-label-row">
          <label for="phone">전화 번호</label>
          <input type="text" id="phone" name="phone" />
        </div>

        <div class="btn-group">
          <button type="submit" class="publish-btn">수정</button>
          <button type="button" class="publish-btn delete-btn" id="delete-btn">
            삭제
          </button>
        </div>
        <div class="msg-area" id="msgArea"></div>
      </form>
    </main>
    <script>
      const STORE_ID = {{ store_id|default(1) }};
      
      // 뒤로가기 시 매장 검색 페이지로 이동하도록 설정
      window.addEventListener('popstate', function(event) {
        window.location.href = '/admin/store/search';
      });
      
      // 페이지 로드 시 히스토리에 매장 검색 페이지 추가
      history.pushState({ page: 'store_edit' }, '', window.location.href);
      
      async function loadStoreInfo() {
        try {
          console.log('매장 정보 로드 시작, STORE_ID:', STORE_ID);
          const res = await fetch(`/api/stores/${STORE_ID}`);
          console.log('응답 상태:', res.status, res.statusText);
          
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            const errorMsg = errorData.error || `서버 오류 (${res.status})`;
            console.error('API 오류:', errorMsg);
            document.getElementById('msgArea').textContent = `매장 정보를 불러올 수 없습니다: ${errorMsg}`;
            return;
          }
          
          const data = await res.json();
          console.log('받은 데이터:', data);
          
          // API 필드명과 HTML 필드명 매핑
          // API는 'open', 'close'를 반환하지만 HTML은 'open', 'close'를 사용
          document.getElementById('name').value = data.name || '';
          document.getElementById('address').value = data.address || '';
          document.getElementById('open').value = data.open || '';
          document.getElementById('close').value = data.close || '';
          document.getElementById('phone').value = data.phone || '';
          
          // 성공 시 메시지 영역 초기화
          document.getElementById('msgArea').textContent = '';
        } catch(e) {
          console.error('로드 오류:', e);
          document.getElementById('msgArea').textContent = `오류 발생: ${e.message}`;
        }
      }
      document.getElementById('store-edit-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const data = {
          name: document.getElementById('name').value,
          address: document.getElementById('address').value,
          open: document.getElementById('open').value,
          close: document.getElementById('close').value,
          phone: document.getElementById('phone').value
        };
        const res = await fetch(`/api/stores/${STORE_ID}`, {
          method: 'PUT',
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert('수정되었습니다');
          // 수정 완료 후 매장 상세 페이지로 이동 (캐시 무시를 위해 타임스탬프 추가)
          window.location.href = `/ranking/store_info/${STORE_ID}?t=${Date.now()}`;
        } else {
          document.getElementById('msgArea').textContent = result.error || '수정 실패';
        }
      });
      document.getElementById('delete-btn').addEventListener('click', async function(){
        if(!confirm('정말 이 매장을 삭제하시겠습니까?')) return;
        const res = await fetch(`/api/stores/${STORE_ID}`, {method:'DELETE'});
        const result = await res.json();
        if (res.ok) {
          alert('삭제되었습니다');
          setTimeout(()=>window.location.href='/admin/store/search', 500);
        } else {
          document.getElementById('msgArea').textContent = result.error || '삭제 실패';
        }
      });
      window.onload = loadStoreInfo;
    </script>
  </body>
</html>

