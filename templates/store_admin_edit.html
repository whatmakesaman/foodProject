<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë§¤ì¥ ì •ë³´ ìˆ˜ì •</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/Home.css" />
    <link rel="stylesheet" href="/static/form-style.css" />
    <link rel="stylesheet" href="/static/store_admin_edit.css" />
  </head>
  <body>
    <header class="top-nav">
      <div class="nav-left">
        <span class="form-title-text">ğŸ“„ë§¤ì¥ ìƒì„¸ ì •ë³´</span>
      </div>
      <div class="nav-right">
        <button class="publish-btn" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>
    <main>
      <form class="form-card" id="store-edit-form">
        <h2 style="margin-bottom: 20px">ë§¤ì¥ ì •ë³´ ìˆ˜ì •</h2>
        <div class="form-label-row">
          <label for="name">ê°€ê²Œ ì´ë¦„</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="form-label-row">
          <label for="address">ì£¼ì†Œ</label>
          <input type="text" id="address" name="address" required />
        </div>
        <div class="form-label-row">
          <label for="open">ì˜¤í”ˆ ì‹œê°„</label>
          <input type="text" id="open" name="open" />
        </div>
        <div class="form-label-row">
          <label for="close">ë§ˆê° ì‹œê°„</label>
          <input type="text" id="close" name="close" />
        </div>
        <div class="form-label-row">
          <label for="phone">ì „í™” ë²ˆí˜¸</label>
          <input type="text" id="phone" name="phone" />
        </div>

        <div class="btn-group">
          <button type="submit" class="publish-btn">ìˆ˜ì •</button>
          <button type="button" class="publish-btn delete-btn" id="delete-btn">
            ì‚­ì œ
          </button>
        </div>
        <div class="msg-area" id="msgArea"></div>
      </form>
    </main>
    <script>
      const STORE_ID = {{ store_id|default(1) }};


      window.addEventListener('popstate', function(event) {
        window.location.href = '/admin/store/search';
      });


      history.pushState({ page: 'store_edit' }, '', window.location.href);

      async function loadStoreInfo() {
        try {
          console.log('ë§¤ì¥ ì •ë³´ ë¡œë“œ ì‹œì‘, STORE_ID:', STORE_ID);
          const res = await fetch(`/api/stores/${STORE_ID}`);
          console.log('ì‘ë‹µ ìƒíƒœ:', res.status, res.statusText);

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            const errorMsg = errorData.error || `ì„œë²„ ì˜¤ë¥˜ (${res.status})`;
            console.error('API ì˜¤ë¥˜:', errorMsg);
            document.getElementById('msgArea').textContent = `ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${errorMsg}`;
            return;
          }

          const data = await res.json();
          console.log('ë°›ì€ ë°ì´í„°:', data);


          document.getElementById('name').value = data.name || '';
          document.getElementById('address').value = data.address || '';
          document.getElementById('open').value = data.open || '';
          document.getElementById('close').value = data.close || '';
          document.getElementById('phone').value = data.phone || '';


          document.getElementById('msgArea').textContent = '';
        } catch(e) {
          console.error('ë¡œë“œ ì˜¤ë¥˜:', e);
          document.getElementById('msgArea').textContent = `ì˜¤ë¥˜ ë°œìƒ: ${e.message}`;
        }
      }
      document.getElementById('store-edit-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const data = {
          name: document.getElementById('name').value,
          address: document.getElementById('address').value,
          open: document.getElementById('open').value,
          close: document.getElementById('close').value,
          phone: document.getElementById('phone').value
        };
        const res = await fetch(`/api/stores/${STORE_ID}`, {
          method: 'PUT',
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
          // ìˆ˜ì • ì™„ë£Œ í›„ ë§¤ì¥ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = `/ranking/store_info/${STORE_ID}?t=${Date.now()}`;
        } else {
          document.getElementById('msgArea').textContent = result.error || 'ìˆ˜ì • ì‹¤íŒ¨';
        }
      });
      document.getElementById('delete-btn').addEventListener('click', async function(){
        if(!confirm('ì •ë§ ì´ ë§¤ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const res = await fetch(`/api/stores/${STORE_ID}`, {method:'DELETE'});
        const result = await res.json();
        if (res.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
          setTimeout(()=>window.location.href='/admin/store/search', 500);
        } else {
          document.getElementById('msgArea').textContent = result.error || 'ì‚­ì œ ì‹¤íŒ¨';
        }
      });

      // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
      function logout() {
        if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          // localStorageì—ì„œ ëª¨ë“  ì¸ì¦ ì •ë³´ ì œê±°
          localStorage.removeItem("token");
          localStorage.removeItem("user_id");
          localStorage.removeItem("user_name");
          localStorage.removeItem("isAdmin");
          localStorage.removeItem("adminId");
          localStorage.removeItem("admin_name");
          localStorage.removeItem("adminName");

          // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = "/login";
        }
      }

      // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ì•„ì›ƒ
      document.getElementById("logout-btn").addEventListener("click", logout);

      window.onload = loadStoreInfo;
    </script>
  </body>
</html>
