<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë§¤ì¥ ìƒì„¸ ì •ë³´</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- static/Home.css -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='Home.css') }}"
    />

    <!-- static/css/form-style.css -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/form-style.css') }}"
    />

    <!-- static/store_detail.css -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='store_detail.css') }}"
    />
  </head>
  <body>
    <header class="top-nav">
      <div class="nav-left">
        <span class="form-title-text">ë¯¸ì‹ì˜ ì™•</span>
      </div>
      <div class="nav-right">
        <div class="profile-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
            />
          </svg>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="form-container">
        <!-- ë§¤ì¥ ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
        <div class="form-card" id="store-info-card">
          <div class="store-info-header">
            <button
              class="back-btn-inline"
              id="back-btn-inline"
              title="ë’¤ë¡œê°€ê¸°"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
                />
              </svg>
            </button>
            <div class="form-header">
              <h2 class="store-name" id="store-name">ë¡œë”© ì¤‘...</h2>
              <div class="store-meta">
                <span id="store-address"></span>
                <span id="store-phone"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- í†µê³„ ì •ë³´ ì¹´ë“œ -->
        <div class="form-card" id="stats-card">
          <div class="form-header">
            <h3>ë§¤ì¥ ì •ë³´</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">í‰ê·  í‰ì </span>
                <span class="stat-value" id="avg-rating">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ë¦¬ë·° ìˆ˜</span>
                <span class="stat-value" id="review-count">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ë² ì´ì§€ì•ˆ ì ìˆ˜</span>
                <span class="stat-value" id="bayes-score">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì£¼ì†Œ</span>
                <span class="stat-value" id="store_address">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ì˜ì—…ì‹œê°„ ì •ë³´ -->
        <div class="form-card" id="hours-card">
          <div class="form-header">
            <h3>ì˜ì—…ì‹œê°„</h3>
            <div class="hours-info">
              <span id="open-time">-</span> ~ <span id="close-time">-</span>
            </div>
          </div>
        </div>

        <!-- ë©”ë‰´ ëª©ë¡ ì¹´ë“œ -->
        <div class="form-card" id="menu-card">
          <div class="form-header">
            <h3>ë©”ë‰´</h3>
            <div id="menu-list" class="menu-list">
              <!-- ë©”ë‰´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
          </div>
        </div>

        <!-- ë¦¬ë·° ëª©ë¡ ì¹´ë“œ -->
        <div class="form-card" id="reviews-card">
          <div class="form-header">
            <h3>ìµœê·¼ ë¦¬ë·°</h3>
            <div id="reviews-list" class="reviews-list">
              <!-- ë¦¬ë·° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
          </div>
        </div>

        <!-- ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="loading-message" class="loading-message">
          ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
        <div
          id="error-message"
          class="error-message"
          style="display: none"
        ></div>
      </div>
    </main>
    <script>
        const STORE_ID = {{ store_id|default(1) }};
        const isAdmin = localStorage.getItem("isAdmin") === "true";

        async function loadStoreDetail() {
          const loadingEl = document.getElementById("loading-message");
          const errorEl = document.getElementById("error-message");
          const storeInfoCard = document.getElementById("store-info-card");
          const statsCard = document.getElementById("stats-card");
          const hoursCard = document.getElementById("hours-card");
          const menuCard = document.getElementById("menu-card");
          const reviewsCard = document.getElementById("reviews-card");

          // ë¡œë”© ìƒíƒœ í‘œì‹œ
          if (loadingEl) loadingEl.style.display = "block";
          if (errorEl) errorEl.style.display = "none";

          try {
            const res = await fetch(`/api/stores/${STORE_ID}/detail`);

            if (!res.ok) {
              const errorData = await res.json().catch(() => ({}));
              errorEl.textContent = errorData.error || "ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
              errorEl.style.display = "block";
              loadingEl.style.display = "none";
              return;
            }

            const data = await res.json();
            loadingEl.style.display = "none";

            // ë§¤ì¥ ê¸°ë³¸ ì •ë³´
            document.getElementById("store-name").textContent =
              data.store.name || "ì´ë¦„ ì—†ìŒ";
            document.getElementById("store-address").textContent =
              data.store.address || "-";
            document.getElementById("store-phone").textContent =
              data.store.phone || "-";

            // í†µê³„ ì •ë³´
            document.getElementById("avg-rating").textContent =
              data.stats.avg_rating ? Number(data.stats.avg_rating).toFixed(2) : "-";
            document.getElementById("review-count").textContent =
              data.stats.review_cnt || 0;
            document.getElementById("bayes-score").textContent =
              data.stats.bayes_score ? Number(data.stats.bayes_score).toFixed(3) : "-";
            document.getElementById("store_address").textContent =
              data.store.address ? data.store.address : "-";

            // ì˜ì—…ì‹œê°„
            document.getElementById("open-time").textContent =
              data.store.open_time || "-";
            document.getElementById("close-time").textContent =
              data.store.close_time || "-";

            // ë©”ë‰´ ëª©ë¡
            const menuListEl = document.getElementById("menu-list");
            if (data.menus && data.menus.length > 0) {
              menuListEl.innerHTML = data.menus
                .map(
                  (menu) => {
                    // íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    const escapedName = (menu.name || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                    return `
                <div class="menu-item" data-menu-id="${menu.menu_id}" data-menu-name="${escapedName}" data-menu-price="${menu.price || 0}">
                  <div>
                    <span class="menu-name">${menu.name}</span>
                    <span class="menu-price">${
                      menu.price ? menu.price.toLocaleString() + "ì›" : "-"
                    }</span>
                    ${menu.recommend ? `<span class="menu-recommend">ì¶”ì²œ</span>` : ""}
                  </div>

                  ${
                    isAdmin
                      ? `
                    <div class="menu-admin-actions">
                      <button class="publish-btn edit-menu-btn" data-menu-id="${menu.menu_id}">
                        ìˆ˜ì •
                      </button>
                      <button class="publish-btn delete-menu-btn" data-menu-id="${menu.menu_id}">
                        ì‚­ì œ
                      </button>
                    </div>
                  `
                      : ""
                  }
                </div>
              `;
                  }
                )
                .join("");

              // ê´€ë¦¬ìì¼ ê²½ìš° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              if (isAdmin) {
                menuListEl.querySelectorAll('.edit-menu-btn').forEach(btn => {
                  btn.addEventListener('click', function() {
                    const menuItem = this.closest('.menu-item');
                    const menuId = parseInt(menuItem.dataset.menuId);
                    const menuName = menuItem.dataset.menuName.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                    const menuPrice = parseInt(menuItem.dataset.menuPrice) || 0;
                    editMenu(menuId, menuName, menuPrice);
                  });
                });

                menuListEl.querySelectorAll('.delete-menu-btn').forEach(btn => {
                  btn.addEventListener('click', function() {
                    const menuId = parseInt(this.dataset.menuId);
                    deleteMenu(menuId);
                  });
                });
              }
            } else {
              menuListEl.innerHTML =
                '<div class="no-data">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            // ë¦¬ë·° ëª©ë¡
            const reviewsListEl = document.getElementById("reviews-list");
            if (data.reviews && data.reviews.length > 0) {
              reviewsListEl.innerHTML = data.reviews
                .map(
                  (review) => `
                <div class="review-item">
                  <div class="review-header">
                    <span class="review-rating">â­ ${review.rating}</span>
                    <span class="review-date">${review.created_at || ""}</span>
                  </div>
                  <div class="review-content">${review.content || ""}</div>
                  ${
                    review.helpful_cnt > 0
                      ? `<div class="review-helpful">ë„ì›€ ${review.helpful_cnt}ê°œ</div>`
                      : ""
                  }
                </div>
              `
                )
                .join("");
            } else {
              reviewsListEl.innerHTML =
                '<div class="no-data">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            // ì¹´ë“œë“¤ í‘œì‹œ
            if (storeInfoCard) storeInfoCard.style.display = "block";
            if (statsCard) statsCard.style.display = "block";
            if (hoursCard) hoursCard.style.display = "block";
            if (menuCard) menuCard.style.display = "block";
            if (reviewsCard) reviewsCard.style.display = "block";

            // âœ… ê´€ë¦¬ìë¼ë©´ ìƒë‹¨/ë©”ë‰´ ê´€ë¦¬ ë²„íŠ¼ ë³´ì´ê¸°
            if (isAdmin) {
              const adminStoreActions = document.getElementById("admin-store-actions");
              const adminMenuActions = document.getElementById("admin-menu-actions");
              if (adminStoreActions) {
                adminStoreActions.style.display = "block";
              }
              if (adminMenuActions) {
                adminMenuActions.style.display = "block";
              }
            }
          } catch (err) {
            console.error("ë§¤ì¥ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            errorEl.textContent =
              "ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            errorEl.style.display = "block";
            loadingEl.style.display = "none";
          }
        }

        // ì¸ë¼ì¸ ë’¤ë¡œê°€ê¸° ë²„íŠ¼
        document
          .getElementById("back-btn-inline")
          .addEventListener("click", () => {
            window.location.href = "/ranking";
          });

        // âœ… ë§¤ì¥ ì •ë³´ ìˆ˜ì • ë²„íŠ¼ í´ë¦­
        if (document.getElementById("edit-store-btn")) {
          document
            .getElementById("edit-store-btn")
            .addEventListener("click", async () => {
              const currentName =
                document.getElementById("store-name").textContent || "";
              const currentAddress =
                document.getElementById("store-address").textContent || "";
              const currentPhone =
                document.getElementById("store-phone").textContent || "";

              const newName = prompt("ìƒˆ ë§¤ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", currentName);
              if (!newName) return;

              const newAddress = prompt(
                "ìƒˆ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì·¨ì†Œ ì‹œ ê¸°ì¡´ ê°’ ìœ ì§€)",
                currentAddress
              );
              const newPhone = prompt(
                "ìƒˆ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì·¨ì†Œ ì‹œ ê¸°ì¡´ ê°’ ìœ ì§€)",
                currentPhone
              );

              const res = await fetch(`/api/admin/store/${STORE_ID}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  name: newName,
                  address: newAddress || currentAddress,
                  phone: newPhone || currentPhone,
                }),
              });

              const result = await res.json();
              alert(result.message || "ìˆ˜ì • ì™„ë£Œ");
              loadStoreDetail();
            });
        }

        // âœ… ë©”ë‰´ ì¶”ê°€ ë²„íŠ¼ í´ë¦­
        if (document.getElementById("add-menu-btn")) {
          document
            .getElementById("add-menu-btn")
            .addEventListener("click", async () => {
              const name = prompt("ì¶”ê°€í•  ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
              if (!name) return;

              const priceStr = prompt("ê°€ê²©ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 8000)");
              const price = Number(priceStr);
              if (!priceStr || Number.isNaN(price)) {
                alert("ê°€ê²©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
                return;
              }

              const res = await fetch(`/api/admin/store/${STORE_ID}/menus`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, price }),
              });
              const result = await res.json();
              alert(result.message || "ë©”ë‰´ ì¶”ê°€ ì™„ë£Œ");
              loadStoreDetail();
            });
        }

        // âœ… ì „ì—­ í•¨ìˆ˜: ë©”ë‰´ ìˆ˜ì • (menu_id, ê¸°ì¡´ ì´ë¦„, ê¸°ì¡´ ê°€ê²©)
      async function editMenu(menuId, currentName = "", currentPrice = 0) {
        const newName = prompt("ìƒˆ ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", currentName);
        if (!newName) return;

        const newPriceStr = prompt("ìƒˆ ê°€ê²©ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”", currentPrice);
        const newPrice = Number(newPriceStr);
        if (!newPriceStr || Number.isNaN(newPrice)) {
          alert("ê°€ê²©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        try {
          const res = await fetch(`/api/admin/menu/${menuId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: newName,
              price: newPrice
            })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            alert(data.message || "ë©”ë‰´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
          }

          alert(data.message || "ë©”ë‰´ ìˆ˜ì • ì™„ë£Œ");
          // ğŸ”¥ ì—¬ê¸°ì„œ ë‹¤ì‹œ ìƒì„¸ ì •ë³´ ë¡œë”©
          await loadStoreDetail();

        } catch (err) {
          console.error(err);
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // âœ… ì „ì—­ í•¨ìˆ˜: ë©”ë‰´ ì‚­ì œ (menu_id í•„ìš”)
      async function deleteMenu(menuId) {
        if (!confirm("ì •ë§ ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          const res = await fetch(`/api/admin/menu/${menuId}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" }
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            alert(data.message || "ë©”ë‰´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
          }

          alert(data.message || "ë©”ë‰´ ì‚­ì œ ì™„ë£Œ");
          // ğŸ”¥ ì—¬ê¸°ì„œ ë‹¤ì‹œ ìƒì„¸ ì •ë³´ ë¡œë”©
          await loadStoreDetail();

        } catch (err) {
          console.error(err);
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

        // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
        function logout() {
          if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            // localStorageì—ì„œ ëª¨ë“  ì¸ì¦ ì •ë³´ ì œê±°
            localStorage.removeItem("token");
            localStorage.removeItem("user_id");
            localStorage.removeItem("user_name");
            localStorage.removeItem("isAdmin");
            localStorage.removeItem("adminId");
            localStorage.removeItem("admin_name");
            localStorage.removeItem("adminName");

            // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = "/login";
          }
        }

        // í”„ë¡œí•„ ì•„ì´ì½˜ í´ë¦­ ì‹œ ë¡œê·¸ì•„ì›ƒ
        document.querySelector(".profile-icon").addEventListener("click", logout);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = loadStoreDetail;
    </script>
  </body>
</html>
