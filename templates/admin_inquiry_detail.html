<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¬¸ì˜ ìƒì„¸ / ë‹µë³€ ì‘ì„±</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/form-style.css') }}" />
</head>
<body>

  <!-- ìƒë‹¨ ë„¤ë¹„ -->
  <div class="top-nav">
    <div class="nav-left">
      <div class="form-icon"><strong>ğŸ“„</strong></div>
      <div class="form-title-group">
        <div class="form-title-text">ë¬¸ì˜ ìƒì„¸</div>
      </div>
    </div>

    <div class="nav-center"></div>

    <div class="nav-right">
      <button class="publish-btn" onclick="location.href='/admin_inquiry_list'">ëª©ë¡ìœ¼ë¡œ</button>
      <div class="profile-icon">A</div>
    </div>
  </div>

  <div class="main-content">
    <div class="tab-menu">
      <button class="tab-btn" onclick="location.href='/admin/store/search'">ë§¤ì¥ ê²€ìƒ‰</button>
      <button class="tab-btn active" onclick="location.href='/admin_inquiry_list'">ë¬¸ì˜</button>
    </div>

    <div class="form-container">
      <!-- ë¬¸ì˜ ì œëª© ì¹´ë“œ -->
      <div class="form-card">
        <div class="form-header">
          <input id="title" class="form-title-input" type="text" value="" readonly />
          <div class="form-description">
            <input id="meta" class="form-description-input" type="text" value="" readonly />
          </div>
        </div>
      </div>

      <!-- ë‚´ìš© & ë‹µë³€ -->
      <div class="form-card">
        <p><strong>ë¬¸ì˜ ë‚´ìš©</strong></p>
        <p id="content" style="margin: 12px 0 20px 0;"></p>

        <p><strong>ë‹µë³€ ì…ë ¥</strong></p>
        <textarea id="answer-input" rows="5"
          style="width:100%; margin-top:8px; padding:8px;"></textarea>

        <button class="publish-btn" style="margin-top:16px;" id="save-btn">ì €ì¥í•˜ê¸°</button>
      </div>

      <div id="msg" style="margin-top:12px; color:#5f6368;"></div>
    </div>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  const titleEl = document.getElementById("title");
  const metaEl = document.getElementById("meta");
  const contentEl = document.getElementById("content");
  const answerInput = document.getElementById("answer-input");
  const msgEl = document.getElementById("msg");

  // ------------------------
  // ë¬¸ì˜ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸°
  // ------------------------
  async function loadInquiry() {
    if (!id) {
      msgEl.style.color = "#d93025";
      msgEl.textContent = "ë¬¸ì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const API = `http://localhost:5000/api/admin/inquiries/${id}`;

    try {
      const res = await fetch(API);
      const data = await res.json();

      if (!res.ok) {
        msgEl.style.color = "#d93025";
        msgEl.textContent = data.error || "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
        return;
      }

      titleEl.value = data.title || "(ì œëª© ì—†ìŒ)";
      metaEl.value =
        `ì‘ì„±ì: ${data.writer} / ì‘ì„±ì¼: ${data.created_at} / ë¶„ì•¼: ${data.field || "-"}`;
      contentEl.textContent = data.content || "";

      if (data.answer) answerInput.value = data.answer;

    } catch (err) {
      console.error(err);
      msgEl.style.color = "#d93025";
      msgEl.textContent = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  // ------------------------
  // ë‹µë³€ ì €ì¥
  // ------------------------
  async function saveAnswer() {
    const answer = answerInput.value.trim();
    if (!answer) {
      alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const API = `http://localhost:5000/api/admin/inquiries/${id}/answer`;

    try {
      const res = await fetch(API, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answer })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "ì €ì¥ ì‹¤íŒ¨");
        return;
      }

      msgEl.style.color = "#188038";
      msgEl.textContent = "ë‹µë³€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
      alert("ì €ì¥ ì™„ë£Œ!");

    } catch (err) {
      console.error(err);
      alert("ì˜¤ë¥˜ ë°œìƒ");
    }
  }

  document.getElementById("save-btn").addEventListener("click", saveAnswer);

  // í˜ì´ì§€ ë¡œë”©
  loadInquiry();

  // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
  function logout() {
    if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      // localStorageì—ì„œ ëª¨ë“  ì¸ì¦ ì •ë³´ ì œê±°
      localStorage.removeItem("token");
      localStorage.removeItem("user_id");
      localStorage.removeItem("user_name");
      localStorage.removeItem("isAdmin");
      localStorage.removeItem("adminId");
      localStorage.removeItem("admin_name");
      localStorage.removeItem("adminName");
      
      // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = "/login";
    }
  }

  // í”„ë¡œí•„ ì•„ì´ì½˜ í´ë¦­ ì‹œ ë¡œê·¸ì•„ì›ƒ
  document.querySelector(".profile-icon").addEventListener("click", logout);
</script>

</body>
</html>
